<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberChat MAX | Реальный чат</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Стили из предыдущего примера (скопируйте весь CSS блок) */
        :root {
            --cyber-primary: #00ff9d;
            --cyber-secondary: #7700ff;
            --cyber-accent: #ff0055;
            --cyber-dark: #0a0a0f;
            --cyber-gray: #1a1a2e;
            --cyber-light: #e0e0ff;
        }
        
        /* ... весь CSS код из предыдущего примера ... */
        /* (скопируйте ВСЕ стили сюда) */
        
        /* Дополнительные стили для реального чата */
        .typing-indicator {
            color: var(--cyber-primary);
            font-style: italic;
            padding: 10px;
            display: none;
        }
        
        .message.sent {
            background: rgba(0, 255, 157, 0.1);
        }
        
        .message.received {
            background: rgba(119, 0, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="cyber-container">
        <!-- Хедер -->
        <header class="cyber-header">
            <div class="logo">
                <i class="fas fa-satellite-dish"></i>
                <h1>CYBER<span class="accent">MAX</span>CHAT</h1>
                <div class="status-indicator">
                    <div class="pulse" id="connectionStatus"></div>
                    <span id="statusText">Подключение...</span>
                </div>
            </div>
            <div class="user-section" id="userSection">
                <button id="loginBtn" class="cyber-btn">
                    <i class="fas fa-terminal"></i> ВХОД
                </button>
            </div>
        </header>

        <!-- Основной контейнер -->
        <main class="main-grid">
            <!-- Левая панель -->
            <aside class="cyber-panel users-panel">
                <h2><i class="fas fa-users"></i> ОНЛАЙН</h2>
                <div class="users-list" id="usersList">
                    <div class="user-card">
                        <div class="user-avatar">S</div>
                        <div class="user-info">
                            <h4>System</h4>
                            <div class="user-status">
                                <span class="status-online">●</span> ONLINE
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel-stats">
                    <div class="stat">
                        <i class="fas fa-bolt"></i>
                        <div>
                            <span class="stat-value" id="onlineCount">1</span>
                            <span class="stat-label">ОНЛАЙН</span>
                        </div>
                    </div>
                    <div class="stat">
                        <i class="fas fa-comments"></i>
                        <div>
                            <span class="stat-value" id="messageCount">0</span>
                            <span class="stat-label">СООБЩЕНИЙ</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Центр - Чат -->
            <section class="cyber-panel chat-panel">
                <div class="chat-header">
                    <h2><i class="fas fa-comment-dots"></i> ОБЩИЙ КАНАЛ</h2>
                    <div class="channel-info">
                        <span class="channel-tag">#GLOBAL</span>
                        <span class="encryption">
                            <i class="fas fa-lock"></i> ЗАЩИЩЕНО
                        </span>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="system-message">
                        <i class="fas fa-robot"></i>
                        <p>Загрузка чата...</p>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    Кто-то печатает...
                </div>
                
                <div class="message-input-container" id="messageInputContainer" style="display: none;">
                    <form id="messageForm" class="message-form">
                        <div class="input-wrapper">
                            <input 
                                type="text" 
                                id="messageInput" 
                                placeholder="ВВЕДИТЕ СООБЩЕНИЕ..." 
                                autocomplete="off"
                                maxlength="500"
                            >
                            <div class="input-actions">
                                <button type="button" class="icon-btn" onclick="toggleEmoji()" title="Эмодзи">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="send-btn">
                            <i class="fas fa-paper-plane"></i> ОТПРАВИТЬ
                        </button>
                    </form>
                </div>
            </section>

            <!-- Правая панель -->
            <aside class="cyber-panel info-panel">
                <h2><i class="fas fa-info-circle"></i> ИНФОРМАЦИЯ</h2>
                <p>Это реальный чат на Supabase.</p>
                <p>Сообщения сохраняются в базе данных.</p>
                <p>Обновляется в реальном времени.</p>
                
                <div class="control-panel">
                    <button class="cyber-btn small" onclick="clearLocalMessages()">
                        <i class="fas fa-trash"></i> Очистить кэш
                    </button>
                    <button class="cyber-btn small" onclick="loadTestMessages()">
                        <i class="fas fa-bolt"></i> Тестовые данные
                    </button>
                </div>
            </aside>
        </main>

        <!-- Модалка входа -->
        <div id="loginModal" class="cyber-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-astronaut"></i> ВХОД В ЧАТ</h2>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="auth-form active">
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="username" placeholder="ВАШЕ ИМЯ" required>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-key"></i>
                        <input type="password" id="password" placeholder="ПАРОЛЬ (любой)" required>
                    </div>
                    <button type="button" onclick="login()" class="auth-submit">
                        <i class="fas fa-sign-in-alt"></i> ПОДКЛЮЧИТЬСЯ
                    </button>
                </div>
                
                <div class="auth-footer">
                    <p><i class="fas fa-exclamation-triangle"></i> Пароль не проверяется (демо)</p>
                </div>
            </div>
        </div>

        <!-- Футер -->
        <footer class="cyber-footer">
            <div class="footer-content">
                <p><i class="fas fa-code"></i> CyberChat v2.0 | Реальный Supabase чат</p>
                <p id="connectionInfo">Статус: Загрузка...</p>
            </div>
        </footer>
    </div>

    <!-- Подключаем Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // === КОНФИГУРАЦИЯ SUPABASE ===
        // ЗАМЕНИТЕ ЭТИ ДАННЫЕ НА СВОИ С SUPABASE!
        const SUPABASE_URL = 'https://ваш-проект.supabase.co'; // Ваш URL
        const SUPABASE_KEY = 'ваш-anon-key'; // Ваш anon key
        
        // === ОСНОВНОЙ КОД ===
        let supabase = null;
        let currentUser = null;
        let isConnected = false;
        let messages = [];
        let onlineUsers = new Set();

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        // Инициализация приложения
        async function initApp() {
            // Проверяем сохраненного пользователя
            const savedUser = localStorage.getItem('chat_username');
            if (savedUser) {
                currentUser = savedUser;
                showChatInterface();
            }
            
            // Подключаемся к Supabase
            await connectToSupabase();
            
            // Загружаем сообщения
            await loadMessages();
            
            // Слушаем новые сообщения
            setupRealtime();
        }

        // Подключение к Supabase
        async function connectToSupabase() {
            try {
                if (!SUPABASE_URL.includes('ваш-проект')) {
                    // Создаем клиент Supabase
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    
                    // Проверяем подключение
                    const { data, error } = await supabase.from('messages').select('count');
                    
                    if (error) {
                        console.error('Ошибка подключения:', error);
                        updateStatus('Ошибка подключения', 'error');
                        // Переходим в локальный режим
                        useLocalMode();
                    } else {
                        updateStatus('Подключено к Supabase', 'success');
                        isConnected = true;
                    }
                } else {
                    // Демо-режим (без реального Supabase)
                    console.log('Демо-режим: используйте LocalStorage');
                    updateStatus('Демо-режим (LocalStorage)', 'warning');
                    useLocalMode();
                }
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                useLocalMode();
            }
        }

        // Локальный режим (если Supabase не настроен)
        function useLocalMode() {
            supabase = null;
            isConnected = false;
            updateStatus('Локальный режим', 'warning');
            
            // Загружаем сообщения из LocalStorage
            const saved = localStorage.getItem('local_messages');
            if (saved) {
                messages = JSON.parse(saved);
                renderMessages();
            }
        }

        // Загрузка сообщений
        async function loadMessages() {
            if (isConnected && supabase) {
                // Загружаем с Supabase
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);
                    
                if (!error && data) {
                    messages = data;
                    renderMessages();
                }
            }
        }

        // Настройка реального времени
        function setupRealtime() {
            if (!isConnected || !supabase) return;
            
            // Подписываемся на новые сообщения
            supabase
                .channel('public:messages')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' }, 
                    (payload) => {
                        // Добавляем новое сообщение
                        messages.push(payload.new);
                        renderMessage(payload.new);
                        updateStats();
                    }
                )
                .subscribe();
        }

        // Отправка сообщения
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentUser) return;
            
            const message = {
                username: currentUser,
                message: text,
                created_at: new Date().toISOString()
            };
            
            // Очищаем поле ввода
            input.value = '';
            
            if (isConnected && supabase) {
                // Отправляем в Supabase
                const { data, error } = await supabase
                    .from('messages')
                    .insert([message]);
                    
                if (error) {
                    console.error('Ошибка отправки:', error);
                    // Сохраняем локально
                    saveLocalMessage(message);
                }
            } else {
                // Локальное сохранение
                saveLocalMessage(message);
            }
        }

        // Локальное сохранение сообщения
        function saveLocalMessage(message) {
            message.id = 'local_' + Date.now();
            messages.push(message);
            renderMessage(message);
            updateStats();
            
            // Сохраняем в LocalStorage
            localStorage.setItem('local_messages', JSON.stringify(messages.slice(-100)));
        }

        // Отображение сообщений
        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            messages.forEach(msg => {
                renderMessage(msg, false);
            });
            
            scrollToBottom();
            updateStats();
        }

        function renderMessage(msg, scroll = true) {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            const isCurrentUser = msg.username === currentUser;
            const time = new Date(msg.created_at).toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
            
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
            messageEl.innerHTML = `
                <div class="message-header">
                    <span class="message-username">${msg.username}</span>
                    <span class="message-time">${time}</span>
                    ${isCurrentUser ? '<span class="user-badge">ВЫ</span>' : ''}
                </div>
                <div class="message-content">
                    <p>${escapeHtml(msg.message)}</p>
                </div>
            `;
            
            container.appendChild(messageEl);
            
            if (scroll) {
                scrollToBottom();
            }
        }

        // Вход в чат
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username) {
                alert('Введите имя пользователя!');
                return;
            }
            
            currentUser = username;
            localStorage.setItem('chat_username', username);
            
            // Добавляем приветственное сообщение
            const welcomeMsg = {
                id: 'welcome',
                username: 'System',
                message: `Добро пожаловать, ${username}!`,
                created_at: new Date().toISOString()
            };
            
            messages.push(welcomeMsg);
            renderMessage(welcomeMsg);
            
            showChatInterface();
            closeModal();
        }

        // Выход
        function logout() {
            currentUser = null;
            localStorage.removeItem('chat_username');
            
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('messageInputContainer').style.display = 'none';
            
            // Сообщение о выходе
            const byeMsg = {
                id: 'bye',
                username: 'System',
                message: 'Вы вышли из чата',
                created_at: new Date().toISOString()
            };
            
            messages.push(byeMsg);
            renderMessage(byeMsg);
        }

        // Показать интерфейс чата
        function showChatInterface() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('messageInputContainer').style.display = 'block';
            
            // Показать пользователя
            const userSection = document.getElementById('userSection');
            userSection.innerHTML = `
                <div class="user-display">
                    <span>${currentUser}</span>
                    <button class="cyber-btn small" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            `;
        }

        // Вспомогательные функции
        function updateStatus(text, type = 'info') {
            document.getElementById('statusText').textContent = text;
            document.getElementById('connectionInfo').textContent = 'Статус: ' + text;
            
            const indicator = document.getElementById('connectionStatus');
            indicator.className = 'pulse ' + type;
        }

        function updateStats() {
            document.getElementById('messageCount').textContent = messages.length;
            document.getElementById('onlineCount').textContent = onlineUsers.size || 1;
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Управление модалкой
        function openModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // Очистка локальных сообщений
        function clearLocalMessages() {
            if (confirm('Очистить историю чата?')) {
                messages = [];
                localStorage.removeItem('local_messages');
                renderMessages();
            }
        }

        // Тестовые данные
        function loadTestMessages() {
            const testMessages = [
                { username: 'Neo', message: 'Добро пожаловать в Матрицу!', created_at: new Date().toISOString() },
                { username: 'Trinity', message: 'Следуй за белым кроликом...', created_at: new Date().toISOString() },
                { username: 'Morpheus', message: 'Что такое реальность?', created_at: new Date().toISOString() }
            ];
            
            testMessages.forEach(msg => {
                msg.id = 'test_' + Date.now() + Math.random();
                messages.push(msg);
                renderMessage(msg);
            });
            
            updateStats();
        }

        // Обработчики событий
        document.getElementById('loginBtn').addEventListener('click', openModal);
        
        document.getElementById('messageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
        
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Клик вне модалки
        document.getElementById('loginModal').addEventListener('click', function(e) {
            if (e.target.id === 'loginModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
